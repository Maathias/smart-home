function isDefined(...d){for(let key in d)if(void 0!==d[key])return d[key]}function isNotEmpty(...d){return""==typeof v?d:v}function isWhat(what){return what&&what.name&&""!=what.name?"[function "+what.name+"]":"["+typeof what+" "+(what?what.constructor.name:"Undefined")+"]"}function getStackTrace(){var obj={};try{Error.captureStackTrace(obj,getStackTrace)}catch(error){return error}obj=obj.stack.split("\n").slice(1);for(let trace in obj)obj[trace]=obj[trace].slice(4);return obj}function makeID(n){for(var out="",chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-",i=0;i<n;i++)out+=chars.charAt(Math.floor(Math.random()*chars.length));return out}function date(format){var d=new Date,out=new String,h=d.getHours()<10?"0"+d.getHours():d.getHours(),m=d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes(),s=d.getSeconds()<10?"0"+d.getSeconds():d.getSeconds(),ms=function(){let ms=d.getMilliseconds();return ms<10?"00"+ms:ms<100?"0"+ms:ms}();switch(format){default:case"long":out=d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+" "+d.getHours()+":"+m+":"+s;break;case"log":let p=(new Date).toString().replace(/[A-Z]{3}\+/,"+").split(/ /);out=p[2]+"/"+p[1]+" "+p[4];break;case"tiny":out=`${h}:${m}:${s}.${ms}`}return out}function timestamp(){return $("<txxblk></txxblk>").addClass("timestamp").append(date("tiny")+" ")}function download(content,filename){var createObjectURL=(window.URL||window.webkitURL||{}).createObjectURL||function(){},blob=null,mimeString="application/octet-stream";if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder){var bb=new BlobBuilder;bb.append(content),blob=bb.getBlob(mimeString)}else blob=new Blob([content],{type:mimeString});var url=createObjectURL(blob),a=document.createElement("a");a.href=url,a.download=filename,a.innerHTML="",document.body.appendChild(a),a.click(),a.remove()}function toTable(content){var $table=$("<table></table>");for(let row of content){let tr=$("<tr></tr>");for(let col of row)tr.append($("<td></td>").append(col+""));$table.append(tr)}return $table}function toGraph(data,x,y){var id=makeID(6);return`<div class="chartdiv"><canvas id="${id}" width="${isDefined(x,400)}" height="${isDefined(y,400)}"></canvas></div><script>var ctx = document.getElementById("${id}").getContext("2d");var myChart = new Chart(ctx, JSON.parse('${JSON.stringify(data)}'));<\/script>`}function toSyntax(data,lang){var langs;lang&&[].push(lang);var hl=hljs.highlightAuto(data,lang),out="",r=/(\<.*?\>)(.*?)(\<\/[\S]*?\>)/g,lines=(out=hl.value.replace(r,function(match,beg,mid,end){return beg+mid.replace(/\n/g,`${end}\n${beg}`)+end})).split("\n"),code=$("<code></code>").append(`\x3c!-- language: ${hl.language}, r: ${hl.r}, second: ${hl.second_best?hl.second_best.language:void 0}--\x3e`);return code.append(hl.value),$("<pre></pre>").append(code)}function getLocal(key){return JSON.parse(localStorage.getItem(key))}function setLocal(key,value){return value=JSON.stringify(value),localStorage.setItem(key,value),value}function getSession(key){return JSON.parse(sessionStorage.getItem(key))}function setSession(key,value){return value=JSON.stringify(value),sessionStorage.setItem(key,value),value}function newScript(url){return new Promise((resolve,reject)=>{var script=document.createElement("script");script.onload=function(){resolve()},script.onerror=function(message){reject(message)},script.src=location.href+url,document.head.appendChild(script)})}function requiresStyle(url){return new Promise((resolve,reject)=>{if(1!=$(`link[href='${url}']`).length){var link=document.createElement("link");link.onload=function(){console.log("resolve"),resolve()},link.href=url,link.rel="stylesheet",document.head.appendChild(link)}})}class Waiter{constructor(list,f){this.list={},this.callback=f;for(let n of list)this.list[n]=!1}update(name){this.list[name]=!0;for(let el in this.list)if(0==this.list[el])return!1;this.callback()}}class Elements{constructor($wind){if(void 0===$wind){var $wind=$("<div></div>").addClass("wind").append($("<input>").addClass("jsonl").prop("type","file").hide()).append($("<div></div>").addClass("commands")).append($("<div></div>").addClass("commline").append($("<span></span>").addClass("ud").append($("<span></span>").addClass("comuser").append($("<txcya></txcya>").append("guest"))).append("@").append($("<txgrn></txgrn>").append(document.title)).append(":").append($("<txblu></txblu>").addClass("commpath").append("~")).append(" $ ")).append($("<input>").addClass("commin").prop("autocomplete","off").prop("autocorrect","off").prop("autocapitalize","off").prop("spellcheck",!1).prop("autofocus",!0)));$("body").append($wind)}this.$wind=$wind,this.$commands=$wind.children(".commands"),this.$ud=$wind.children(".commline").children(".ud"),this.$commuser=$wind.children(".commline").children(".ud").children(".comuser"),this.$commpath=$wind.children(".commline").children(".ud").children(".commpath"),this.$commin=$wind.children(".commline").children(".commin"),this.$jsonl=$wind.children(".jsonl");var icons=$wind.children(".commline").children(".icons");this.$commline=$wind.children(".commline"),this.$commline.enable=function(){this.children(".commin").prop("disabled",!1),this.css("filter","grayscale(0%)")},this.$commline.disable=function(){this.children(".commin").prop("disabled",!0),this.css("filter","grayscale(1000%)")},this.$commuser.change=function(user,badge){this.html(user),this.removeClass(),this.addClass(badge),this.closest(".wind").data("con").updateInputWidth()}}}class Com{constructor(data,con){this.con=con,this.id=makeID(5),this.raw=data.raw,this.c=data.c,this.arg=data.arg,this.$elem=void 0,this.$ud=void 0,this.$sr=void 0,this.formatted=void 0,this.timer=void 0,this.time=performance.now(),this.res=void 0,this.blocks=[],this.__proto__.log=this.con.log,this._init()}_append(){this.$elem=$("<div></div>").prop("id",this.id).addClass("command").append(timestamp(),this.$ud=$("<span></span>").addClass("ud").append($("<span></span>").addClass(this.con.udata.badge).append(this.con.udata.login)).append("@").append($("<txgrn></txgrn>").append(document.title)).append(":").append($("<txblu></txblu>").append(this.con.elements.$commpath.html())).append(" $ ").append($("<span></span>").append(this.raw))).append(this.$sr=$("<div></div>").addClass("sr")).data("com",this),this.con.elements.$commands.append(this.$elem)}_init(){this._append(),this.con.Functions[this.c]?this.con.Functions[this.c](this):this.con.Socket?this.con.Socket.socket.connected?this.con.Socket.send(this):this.log("Server disconnected","error"):this.log("Socket module not available","error")}async update(res){res.end?this._end():(this.con.log(`#${res.res.id} received block`,"info",3),this.blocks[res.meta.n]=res,this._timeout(!0),this._addBlock(this._block(await this.con.unpack(res),res.meta.n)))}_block(data,n){return $(`<div data-n="${n}"</div>`).append(data).append(timestamp())}_addBlock(block){var children=this.$sr.children(),len;if(children.length>0&&-1!=parseInt(block.attr("data-n"))){for(let child of children)if(parseInt($(child).attr("data-n"))>block.attr("data-n"))return void $(child).before(block);this.$sr.append(block)}else this.$sr.append(block)}_end(){this._stopLoading()}_timeout(ok){ok?(this.timer&&clearTimeout(this.timer),this.time=performance.now()-this.time):(this.log("Server timeout","error"),this.res=null,this.insertResponse())}insert(out){this._addBlock(this._block(out,-1))}remove(){this.$elem.remove()}_stopLoading(){this.$ud.attr("loading",null)}_startLoading(){this.$ud.attr("loading"," "),this.time=performance.now()}}class Con{constructor($wind){this.id=makeID(6),this.elements=new Elements($wind),this.history={counter:0,commands:[""],push(com){return this.commands.push(com),this.counter=0,this},increment(){return this.counter++,this.counter>this.commands.length-1&&(this.counter=0),this},decrement(){return this.counter--,this.counter<0&&(this.counter=this.commands.length-1),this},current(){return this.commands[this.counter]},get up(){return this.decrement(),this.commands[this.counter]},get down(){return this.increment(),this.commands[this.counter]}},this.Functions={},this.Classes={},this.m=void 0,this.coms=[],this.scroll=!0,this.jsond=void 0,this.timeout=16e3,this.fConnect=!1,this.first=!1,this.verbose=Config.verbose,this.credentials=getLocal("credentials"),this.udata=getLocal("udata")||{badge:"txcya",login:"guest",group:9,lastLogin:"n/a",shortid:void 0},this.keymap={"2l":()=>this.clear()},this.elements.$commline.ready(()=>{this._ready()})}removeCom(id){this.log("Removing Com #${id} element","warning",2);for(let key in this.coms)if(this.coms[key].id===id)return this.coms[key].remove(),this.log("Com #${id} removed","info",2),!0;return this.log(`Com #${id} element not found`,"error",2),!1}getCom(id){for(let key in this.coms)if(this.coms[key].id==id)return this.coms[key];this.log(`Com #${id} not found`,"error",2)}get lastCom(){return this.coms[con.coms.length-1]}clear(){for(let com of this.coms)this.log(`Removing Com #${com.id}`,"info",2),com.remove();this.log("Clearing commands div","info",2),this.elements.$commands.empty()}executeCom(val){this.log(`Force Com execute: ${val}`,"info",3),this.elements.$commin.val(val),this.commandlineParse()}log(data,opt,lvl){var lvl;if(!((lvl=isDefined(lvl,1))>this.verbose)){var opt;switch(opt=isDefined(opt,"")){default:case"info":opt=["txblu","Info"];break;case"warning":opt=["txyel","Warning"];break;case"error":opt=["txred","Error"];break;case"ok":opt=["txgrn","OK"];break;case"prompt":opt=["txcya","?"]}var out=$("<div></div>").addClass("inline").append(timestamp(),$("<tx></tx>").addClass(opt[0]).append("#".repeat(lvl)).append(` ${opt[1]}: `)).append(data);if(this instanceof Con){var lastlog=this.elements.$commands.children().last();if(lastlog.text()==out.text()){let tx=lastlog.children("tx");lastlog.hasClass("duplicate")||lastlog.addClass("duplicate");let d=isDefined(tx.attr("data-duplicate"),1);return d=parseInt(d),d=(d+=1).toString(),void lastlog.children("tx").attr("data-duplicate",`${d}`)}this.elements.$commands.append(out),this.scrollBottom(!1)}else this instanceof Com&&this.$elem.append(out)}}commandlineParse(){if(!this.elements.$commin.is(":hidden")){var raw=this.elements.$commin.val();if(this.elements.$commin.val(""),""!=raw){if(this.history.push(raw),raw.indexOf(" ")>-1)var arg,c=(arg=raw.split(" ")).shift();else var arg=[],c=raw.toLowerCase();this.coms.push(new Com({raw:raw,c:c,arg:arg},this))}}}async unpack(res){switch(res.meta.flag){default:case 0:return res.data;case 1:return await this._requires("Tree"),new this.Classes.Tree(res.data).$;case 6:break;case 9:case 10:}}getScroll(){var s=this.elements.$wind.scrollTop()-(this.elements.$wind.prop("scrollHeight")-this.elements.$wind.outerHeight());return s>=0?s=0:s*=-1,s}scrollBottom(f){let force;if(isDefined(f,!1))return;let a=this.elements.$commands.children(),b=this.elements.$commands.children().children();var to=0;for(let index of a)to+=index.scrollHeight;for(let index of b)to+=index.scrollHeight;this.elements.$commands.stop().animate({scrollTop:to},200,"swing",function(){})}updateInputWidth(){var w=this.elements.$ud.width()+20;return this.elements.$commin.css({width:`calc(100% - ${w}px)`}),w}commandHistory(key){this.elements.$commin.val(38==key?this.history.up:40==key?this.history.down:""),this.elements.$commin.focus()}readJson(data){var file=data.target.files[0],reader=new FileReader;reader.con=$(this).closest(".wind").data("con"),reader.onload=function(event){try{this.con.jsond=JSON.parse(event.target.result),this.con.log("JSON loaded","ok")}catch(error){this.con.log(`JSON parsing error: ${error}`,"error")}},reader.readAsText(file,"UTF-8")}_getPackage(name){return new Promise((resolve,reject)=>{this.log(`Requesting ${name} module`,"info"),import(`./packages/${name}.js`).then(mod=>{var done=()=>{switch(mod.type){case"sub":try{this.log(`Starting ${name} module`,"info"),this[name]=new mod.default(this)}catch(err){this.log(`Module ${name} failed: ${err}`,"error")}break;case"class":this.Classes[name]=mod.default;break;case"command":for(let f in mod.default)this.Functions[f]=mod.default[f]}this.log(`Downloaded ${name} module`,"ok"),resolve()};if(mod.requires){var list=[];for(let what in mod.requires)list=list.concat(mod.requires[what]);let waiter=new Waiter(list,()=>{done()});if(mod.requires.styles)for(let style of mod.requires.styles)requiresStyle(style).then(()=>{waiter.update(style)});if(mod.requires.scripts)for(let script of mod.requires.scripts)newScript(script).then(()=>{waiter.update(script)})}else done()}).catch(err=>{this.log(`Downloading ${name} module failed: ${err}`,"error"),reject()})})}_requires(name){return Config.packages[name]||(Config.packages[name]=this._getPackage(name)),Config.packages[name]}_optional(name){this.log(`There is an optional module: ${name}, do you want to download it?`,"prompt")}_ready(){$(this.elements.$wind).prop("id",this.id),$(this.elements.$wind).data("con",this),this.elements.$commline.on("keydown","input",function(e){var con=$(this).closest(".wind").data("con");switch(e.which){case 13:con.commandlineParse();break;case 38:case 40:con.commandHistory(e.which),e.preventDefault();break;case 27:con.elements.$commin.val("")}}),this.elements.$wind.on("click",".collapse",function(e){var collapse=$(this);collapse.parent().children("ul").slideToggle(200),collapse.children("i").hasClass("icon-minus-squared")?(collapse.children("i").removeClass(),collapse.children("i").addClass("icon-plus-squared")):(collapse.children("i").removeClass(),collapse.children("i").addClass("icon-minus-squared"))}),this.elements.$wind.on("keydown",e=>{var val=1*e.altKey+2*e.ctrlKey+3*e.metaKey+4*e.shiftKey+e.key;this.keymap[val]&&(this.keymap[val](),e.preventDefault())}),this.elements.$commands.on("keydown","form",function(e){var com=$(this).closest(".command").data("com");switch(e.which){case 13:com.sendForm();break;case 27:com.removeForm()}}),this.elements.$wind.on("click","a",function(e){var a=$(this),href=a.prop("href");(href=href.slice(href.indexOf("#"))).startsWith("#")&&(e.preventDefault(),a.closest(".wind").data("con").executeCom(decodeURIComponent(href.slice(1))))}),this.elements.$jsonl[0].addEventListener("change",this.readJson,!1),this.updateInputWidth(),this.log("Console ready","ok"),this._requires("Socket"),this._requires("Essentials")}}var Config={notif:new Audio("res/unsure.mp3"),treeDepth:4,socket:void 0,cons:[],packages:{},verbose:2,serviceWorker:!1};$(document).ready(function(){$("noscript").remove(),Config.notif.volume=.3,Config.cons.push(new Con),con=Config.cons[0],"serviceWorker"in navigator&&Config.serviceWorker&&navigator.serviceWorker.register("service-worker.js").then(reg=>console.log("sw registered")).catch(error=>console.log(`sw error: ${error}`)),setInterval(function(){$(".ud").length&&$(".ud").each(function(index){var c=$(this),s=c.attr("loading");if(void 0!==s)switch(s){case"[--------]":c.attr("loading","[#-------]");break;case"[#-------]":c.attr("loading","[##------]");break;case"[##------]":c.attr("loading","[###-----]");break;case"[###-----]":c.attr("loading","[####----]");break;case"[####----]":c.attr("loading","[#####---]");break;case"[#####---]":c.attr("loading","[######--]");break;case"[######--]":c.attr("loading","[#######-]");break;case"[#######-]":c.attr("loading","[########]");break;default:case"[########]":c.attr("loading","[--------]")}})},250)});